# Personalized Feed Recommendation Service (FastAPI + CatBoost)

Этот проект — часть финального проекта на курсе «Инженер машинного обучения» от Karpov.Courses.  
Здесь реализован сервис персональных рекомендаций постов для пользователей.

## Функционал проекта

Проект включает:

- feature engineering для пользователей и постов
- извлечение текстовых признаков постов через BERT
- загрузку готовых витрин фичей в PostgreSQL
- обучение модели CatBoost для ранжирования постов
- FastAPI сервис для выдачи рекомендаций
- эндпоинт, который возвращает **топ-N постов** для пользователя

---

## Модель

Используется **CatBoostClassifier**, обученный на:

### Time-features
- `hour`, `weekday`, `is_weekend`

### User-features
- демография и устройство (OHE: `gender`, `os`, `source`, `exp_group`)
- частоты `city_freq`, `country_freq`
- агрегаты по пользователю на train-части:
  - `user_views`, `user_likes`, `user_ctr`

### Post-features
- OHE тем постов (`topic_*`)
- простые текстовые признаки:
  - `text_len`, `text_diversity` (и др. при необходимости)
- агрегаты по посту на train-части:
  - `post_views`, `post_likes`, `post_ctr`

### Текстовые признаки через BERT
Текст постов обрабатывается через BERT:
- CLS-эмбеддинги
- PCA-сжатие эмбеддингов (`bert_pca_*`)
- KMeans-кластеры текста (`text_cluster_*`)
- расстояния до центров кластеров (`DistanceToCluster_*`)

Модель сохранена в файл: `catboost_model.cbm`

> Примечание: точное значение метрики зависит от разбиения и окружения.  
> В ноутбуке метрика считается оффлайн, а в LMS могла отличаться из-за другого протокола тестирования.

---

## Структура базы данных

Используются витрины фичей (готовые таблицы, которые сервис просто читает):

1) **User features**  
   Таблица: `public.arsenij_shmelev_gwh6987_features_lesson_22_user`  
   Содержит `user_id` и все пользовательские признаки.

2) **Post features**  
   Таблица: `public.arsenij_shmelev_gwh6987_features_lesson_22_post`  
   Содержит `post_id` и все постовые признаки (включая BERT-фичи и статистики).

3) **Тексты постов для ответа сервиса**  
   Таблица: `public.post_text_df`  
   Содержит `post_id`, `text`, `topic`.  
   Используется только для формирования ответа (`text`, `topic`). В модель эти строки не подаются.

---

## Как работает сервис

Сервис поднимает FastAPI и на запрос пользователя строит матрицу признаков:

- берёт все строки из `post_features` (это кандидаты постов)
- добавляет к ним user-фичи конкретного пользователя
- добавляет time-фичи из параметра `time`
- выравнивает набор/порядок колонок под модель
- считает вероятность лайка и возвращает топ-N постов

### Эндпоинт
`GET /post/recommendations/`

### Параметры

| Параметр | Тип      | Описание                              |
|---------|----------|----------------------------------------|
| id      | int      | `user_id` для рекомендаций             |
| time    | datetime | текущее время                          |
| limit   | int      | количество возвращаемых постов (по умолчанию 5) |

### Пример запроса

```python
import requests
from datetime import datetime

params = {
    "id": 203,
    "time": datetime(2020, 5, 17),
    "limit": 5
}

resp = requests.get("http://127.0.0.1:8000/post/recommendations/", params=params)
print(resp.json())
